{{- if eq (include "installOpenSearchDashboards" .) "true" -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: opensearch-dashboards-install-index-pattern
spec:
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: analyticsinstall
      initContainers:
      - name: wait-for-opensearch-dashboards
        image: {{ .Values.curl.image.repository }}:{{ .Values.curl.image.tag }}
        command: ["/bin/sh","-c"]
        args: ["while [ $(curl -sw '%{http_code}' http://opensearch-dashboards:5601/api/status -o /dev/null) -ne 200 ]; do sleep 5; echo 'Waiting for os-dashboards...'; done"]
      containers:
      - name: config-opensearch-index-pattern
        image: {{ .Values.curl.image.repository }}:{{ .Values.curl.image.tag }}
        command:
          - /bin/sh
          - -c
          - |
            curl -XPOST -u 'kibanaserver:kibanaserver' -H 'Content-Type: application/json' -H 'osd-xsrf: true' 'opensearch-dashboards:5601/api/saved_objects/index-pattern/contrail.kubernetes-*?overwrite=true' --data '{"attributes":{"title":"contrail.kubernetes-*","timeFieldName":"@timestamp"}}'
            curl -XPOST -u 'kibanaserver:kibanaserver' -H 'Content-Type: application/json' -H 'osd-xsrf: true' 'opensearch-dashboards:5601/api/saved_objects/index-pattern/contrail.uve*?overwrite=true' --data '{"attributes":{"title":"contrail.uve.*","timeFieldName":"@timestamp"}}'
            curl -XPOST -u 'kibanaserver:kibanaserver' -H 'Content-Type: application/json' -H 'osd-xsrf: true' 'opensearch-dashboards:5601/api/saved_objects/index-pattern/contrail.object*?overwrite=true' --data '{"attributes":{"title":"contrail.object.*","timeFieldName":"@timestamp"}}'
            curl -XPUT -u 'admin:admin' -H 'Content-Type: application/json' -H 'osd-xsrf: true' 'opensearch-dashboards:5601/api/ism/policies/data-retention' --data '{"policy":{"description": "Contrail data retention policy.","default_state": "Open", "states": [{"name": "Open","actions": [],"transitions": [{"state_name": "Deleting","conditions": {"min_index_age": "7d"}}]},{"name": "Deleting","actions": [{"delete": {}}],"transitions": []}],"ism_template": [{"index_patterns": ["contrail.*"]}]}}'

{{- if .Values.curl.imagePullSecrets }}
      imagePullSecrets:
{{ toYaml .Values.curl.imagePullSecrets | indent 8 }}
      {{- end }}
{{ end }}
